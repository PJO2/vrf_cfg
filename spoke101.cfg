route-map SETCT77
route-map SETCT55
interface vasileft 1
interface vasileft 2
interface vasileft 3
int gi 3.31
int gi 3.41
int gi 3.46

no vrf definition Video
no vrf definition Phone
no vrf definition Data
no router bgp 65000
no route-map SETCT77
no route-map SETCT55
no interface Loopback 100
no ip prefix-list DENY_ALL

no interface vasileft 1
no interface vasileft 2
no interface vasileft 3
no interface vasiright 1
no interface vasiright 2
no interface vasiright 3

no int gi 3.31
no int gi 3.41
no int gi 3.46
! --------------------------------------------- 
! CE to PE peering
! Constructor
! ---------------------------------------------




route-map SETCT77
  set community 65000:77
exit
! --------------------------------------------- 
! CE to PE peering
! extra points on site.vars.wan[!q!name==role]
! ---------------------------------------------

! called with extra: {'name': 'primary', 'ip': '10.24.31.1'}

router bgp 65000
  neighbor 10.24.31.1 remote-as 25186
  neighbor 10.24.31.1 description -- primary peer to PE--
  neighbor 10.24.31.1 timers 15 45
  
  address-family ipv4
  neighbor 10.24.31.1 activate
  neighbor 10.24.31.1 route-map SETCT77 out
  exit-address-family

exit

! --------------------------------------------- 
! CE to RS peering
! ---------------------------------------------

! role is dual1
! role id is 1



interface Loopback 100 
  description -- BGP to RS peering --
  ip address 172.20.1.101 255.255.255.255

router bgp 65000
  no bgp default ipv4-unicast
  neighbor  RS  peer-group
  neighbor  RS  timers 15 45
  neighbor  RS  remote-as 65500
  neighbor  RS  description -- To route-server --
!  neighbor  RS  ebgp-multihop 255
  neighbor  RS  update-source Loopback100
 address-family vpnv4
    neighbor  RS  allowas-in
    neighbor  RS  soo 65000:101
    neighbor  RS  send-community both
!    neighbor  RS  inter-as-hybrid
  exit-address-family

  address-family ipv4
     ! advertise the Loopback to the underlay
     network 172.20.1.101 mask 255.255.255.255
  exit-address-family


 neighbor 172.20.0.0 peer-group RS
 neighbor 172.20.0.0 description -- To route-server RS1 --
 address-family vpnv4
   neighbor 172.20.0.0 activate
  exit-address-family

 neighbor 172.20.0.1 peer-group RS
 neighbor 172.20.0.1 description -- To route-server RS2 --
 address-family vpnv4
   neighbor 172.20.0.1 activate
  exit-address-family


exit
! B2B template for dual1 routers

! --------------------------------------------- 
! Per VRF configuration constructor
! ---------------------------------------------

ip prefix-list DENY_ALL seq 5 deny 0.0.0.0/0 le 32


router bgp 65000
  bgp log-neighbor-changes
  no bgp default ipv4-unicast
exit! --------------------------------------------- 
! Per VRF configuration
! iteration clause : device.site.vars.vrfs
!    item  !
!          ! -- name
!          ! -- lan
!          !     -- ip: 192.268.0.1/24
! extra points on : device.tenant.vars.vrf[current]
!    extra !
!          ! -- name
!          ! -- id
!          ! -- type
!     
! ---------------------------------------------


# vrf definition :
vrf definition Video
   rd 65000:1019041
   ! depending on VRF Type Hub And Spoke or Any to Any (for now any to any)
   route-target both  65000:1010041  
   address-family ipv4
       inter-as-hybrid next-hop 10.0.1.0
   exit-address-family
exit
 
  
# vasi definitions:
interface vasileft 1
  description -- dataplane and controlplane leaking from VRF to GRT --
  vrf forwarding Video
  ip address 10.0.1.1 255.255.255.254
  
interface vasiright 1
  description -- dataplane and controlplane leaking from GRT to VRF Video --
  ip address 10.0.1.0 255.255.255.254

# BGP control plane
router bgp 65000
 ! Vasi 
 neighbor 10.0.1.1 remote-as 65000
 neighbor 10.0.1.1 description --Vasi1--
!
 address-family ipv4
  neighbor 10.0.1.1 activate
  ! GRT has received all route, advertise none  to VRFs 
  neighbor 10.0.1.1 prefix-list DENY_ALL out
 exit-address-family
 !
 address-family ipv4 vrf Video
  ! Necessary to change its own router-id
  bgp router-id 10.0.1.1
  network 10.101.41.0 mask 255.255.255.0
  neighbor 10.0.1.0 remote-as 65000
  neighbor 10.0.1.0 activate
 exit-address-family


! configure LAN interface
int gi 3.41
   description -- LAN interface for VRF Video
   encapsulation dot1q 41
   vrf forwarding Video
   ip address 10.101.41.1 255.255.255.0
 exit
! --------------------------------------------- 
! Per VRF configuration
! iteration clause : device.site.vars.vrfs
!    item  !
!          ! -- name
!          ! -- lan
!          !     -- ip: 192.268.0.1/24
! extra points on : device.tenant.vars.vrf[current]
!    extra !
!          ! -- name
!          ! -- id
!          ! -- type
!     
! ---------------------------------------------


# vrf definition :
vrf definition Phone
   rd 65000:1019046
   ! depending on VRF Type Hub And Spoke or Any to Any (for now any to any)
   route-target both  65000:1010046  
   address-family ipv4
       inter-as-hybrid next-hop 10.0.2.0
   exit-address-family
exit
 
  
# vasi definitions:
interface vasileft 2
  description -- dataplane and controlplane leaking from VRF to GRT --
  vrf forwarding Phone
  ip address 10.0.2.1 255.255.255.254
  
interface vasiright 2
  description -- dataplane and controlplane leaking from GRT to VRF Phone --
  ip address 10.0.2.0 255.255.255.254

# BGP control plane
router bgp 65000
 ! Vasi 
 neighbor 10.0.2.1 remote-as 65000
 neighbor 10.0.2.1 description --Vasi2--
!
 address-family ipv4
  neighbor 10.0.2.1 activate
  ! GRT has received all route, advertise none  to VRFs 
  neighbor 10.0.2.1 prefix-list DENY_ALL out
 exit-address-family
 !
 address-family ipv4 vrf Phone
  ! Necessary to change its own router-id
  bgp router-id 10.0.2.1
  network 10.101.46.0 mask 255.255.255.0
  neighbor 10.0.2.0 remote-as 65000
  neighbor 10.0.2.0 activate
 exit-address-family


! configure LAN interface
int gi 3.46
   description -- LAN interface for VRF Phone
   encapsulation dot1q 46
   vrf forwarding Phone
   ip address 10.101.46.1 255.255.255.0
 exit
! --------------------------------------------- 
! Per VRF configuration
! iteration clause : device.site.vars.vrfs
!    item  !
!          ! -- name
!          ! -- lan
!          !     -- ip: 192.268.0.1/24
! extra points on : device.tenant.vars.vrf[current]
!    extra !
!          ! -- name
!          ! -- id
!          ! -- type
!     
! ---------------------------------------------


# vrf definition :
vrf definition Data
   rd 65000:1019031
   ! depending on VRF Type Hub And Spoke or Any to Any (for now any to any)
   route-target both  65000:1010031  
   address-family ipv4
       inter-as-hybrid next-hop 10.0.3.0
   exit-address-family
exit
 
  
# vasi definitions:
interface vasileft 3
  description -- dataplane and controlplane leaking from VRF to GRT --
  vrf forwarding Data
  ip address 10.0.3.1 255.255.255.254
  
interface vasiright 3
  description -- dataplane and controlplane leaking from GRT to VRF Data --
  ip address 10.0.3.0 255.255.255.254

# BGP control plane
router bgp 65000
 ! Vasi 
 neighbor 10.0.3.1 remote-as 65000
 neighbor 10.0.3.1 description --Vasi3--
!
 address-family ipv4
  neighbor 10.0.3.1 activate
  ! GRT has received all route, advertise none  to VRFs 
  neighbor 10.0.3.1 prefix-list DENY_ALL out
 exit-address-family
 !
 address-family ipv4 vrf Data
  ! Necessary to change its own router-id
  bgp router-id 10.0.3.1
  network 10.101.31.0 mask 255.255.255.0
  neighbor 10.0.3.0 remote-as 65000
  neighbor 10.0.3.0 activate
 exit-address-family


! configure LAN interface
int gi 3.31
   description -- LAN interface for VRF Data
   encapsulation dot1q 31
   vrf forwarding Data
   ip address 10.101.31.1 255.255.255.0
 exit

banner exec "router by Orange"
! author is : PJO2
